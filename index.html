<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CulturalBot - Your Local Guide</title>
    <style>
        /* Full styling as provided before */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            width: 90%;
            max-width: 1200px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            height: 700px;
        }

        .sidebar {
            width: 300px;
            background: linear-gradient(180deg, #2c3e50 0%, #3498db 100%);
            padding: 20px;
            color: white;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .logo p {
            font-size: 12px;
            opacity: 0.8;
        }

        .city-selector {
            margin-bottom: 20px;
        }

        .city-selector select {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            backdrop-filter: blur(10px);
        }

        .city-selector select option {
            background: #2c3e50;
            color: white;
        }

        .categories {
            margin-bottom: 20px;
        }

        .categories h3 {
            margin-bottom: 15px;
            font-size: 16px;
        }

        .category-btn {
            display: block;
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .category-btn:hover, .category-btn.active {
            background: rgba(255, 255, 255, 0.3);
            transform: translateX(5px);
        }

        .user-prefs {
            margin-top: 20px;
        }

        .user-prefs h4 {
            margin-bottom: 10px;
            font-size: 14px;
        }

        .pref-input {
            width: 100%;
            padding: 8px;
            margin-bottom: 8px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 12px;
        }

        .pref-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .header {
            padding: 20px;
            background: linear-gradient(90deg, #f8f9fa, #e9ecef);
            border-bottom: 1px solid #dee2e6;
        }

        .header h2 {
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .header p {
            color: #6c757d;
            font-size: 14px;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            max-height: 400px;
        }

        .message {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 15px;
            max-width: 70%;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-message {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .bot-message {
            background: #f8f9fa;
            color: #2c3e50;
            border: 1px solid #e9ecef;
        }

        .bot-message .category {
            font-weight: bold;
            color: #3498db;
            margin-bottom: 5px;
        }

        .recommendation {
            background: linear-gradient(135deg, #84fab0, #8fd3f4);
            margin: 10px 0;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }

        .recommendation h4 {
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .recommendation p {
            font-size: 14px;
            margin-bottom: 5px;
        }

        .rating {
            color: #f39c12;
            font-size: 14px;
        }

        .input-container {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 15px;
        }

        .message-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #dee2e6;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .message-input:focus {
            border-color: #3498db;
        }

        .send-btn {
            padding: 12px 20px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: transform 0.2s ease;
        }

        .send-btn:hover {
            transform: scale(1.05);
        }

        .quick-suggestions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .quick-btn {
            padding: 8px 12px;
            background: rgba(52, 152, 219, 0.1);
            color: #3498db;
            border: 1px solid #3498db;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .quick-btn:hover {
            background: #3498db;
            color: white;
        }

        .loading {
            display: none;
            text-align: center;
            color: #6c757d;
            font-style: italic;
        }

        .weather-info {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            margin: 10px 0;
            font-size: 14px;
        }

        .map-placeholder {
            width: 100%;
            height: 150px;
            background: linear-gradient(135deg, #ddd, #f0f0f0);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            margin: 10px 0;
            font-size: 14px;
        }

        .local-contribution {
            background: linear-gradient(135deg, #ff9a9e, #fecfef);
            padding: 15px;
            border-radius: 15px;
            margin: 10px 0;
            border-left: 4px solid #e91e63;
        }

        .local-contribution .contributor {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .add-recommendation-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            margin: 10px 0;
            transition: transform 0.2s ease;
        }

        .add-recommendation-btn:hover {
            transform: scale(1.05);
        }

        .contribution-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin: 15px 0;
            border: 2px dashed #dee2e6;
            display: none;
        }

        .contribution-form.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-group textarea {
            height: 80px;
            resize: vertical;
        }

        .submit-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }

        .cancel-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .learning-stats {
            background: linear-gradient(135deg, #84fab0, #8fd3f4);
            padding: 10px 15px;
            border-radius: 10px;
            margin: 10px 0;
            font-size: 12px;
            text-align: center;
        }

        .validation-badge {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            margin-left: 5px;
        }

        .pending-badge {
            display: inline-block;
            background: #ffc107;
            color: #212529;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            margin-left: 5px;
        }

        .trending-recommendations {
            background: linear-gradient(135deg, #ffecd2, #fcb69f);
            padding: 15px;
            border-radius: 15px;
            margin: 10px 0;
            border-left: 4px solid #ff6b6b;
        }

        .ai-insight {
            background: linear-gradient(135deg, #a8edea, #fed6e3);
            padding: 12px;
            border-radius: 10px;
            margin: 10px 0;
            font-size: 14px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="logo">
                <h1>üåç CulturalBot</h1>
                <p>Your AI Local Guide</p>
            </div>

            <div class="city-selector">
                <select id="citySelect">
                    <option value="tokyo">üóû Tokyo, Japan</option>
                    <option value="paris">üóº Paris, France</option>
                    <option value="mumbai">üáÆüá≥ Mumbai, India</option>
                    <option value="istanbul">üïú Istanbul, Turkey</option>
                    <option value="newyork">üóΩ New York, USA</option>
                    <option value="london">üè∞ London, UK</option>
                    <option value="delhi">üèõÔ∏è Delhi, India</option>
                    <option value="barcelona">üèõÔ∏è Barcelona, Spain</option>
                </select>
            </div>

            <div class="categories">
                <h3>Explore Categories</h3>
                <button class="category-btn" data-category="food">üçú Local Food</button>
                <button class="category-btn" data-category="streets">üõ£Ô∏è Famous Streets</button>
                <button class="category-btn" data-category="clothing">üëò Traditional Clothing</button>
                <button class="category-btn" data-category="culture">üé≠ Cultural Sites</button>
                <button class="category-btn" data-category="markets">üõçÔ∏è Local Markets</button>
                <button class="category-btn" data-category="festivals">üéâ Festivals & Events</button>
                <button class="category-btn" data-category="arts">üé® Arts & Crafts</button>
                <button class="category-btn" data-category="nightlife">üåô Nightlife</button>
            </div>

            <div class="user-prefs">
                <h4>Your Preferences</h4>
                <input type="text" class="pref-input" id="budget" placeholder="Budget (e.g., $50/day)" />
                <input type="text" class="pref-input" id="interests" placeholder="Interests (e.g., history, art)" />
                <input type="text" class="pref-input" id="dietary" placeholder="Dietary restrictions" />

                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2);">
                    <h4>üåü Help Us Learn</h4>
                    <p style="font-size: 11px; opacity: 0.8; margin-bottom: 8px;">Are you a local? Share your recommendations!</p>
                    <label style="display: flex; align-items: center; font-size: 12px; margin-bottom: 5px;">
                        <input type="checkbox" id="localCheckbox" style="margin-right: 5px; width: auto;" />
                        I'm a local resident
                    </label>
                    <button class="add-recommendation-btn" id="addRecommendationBtn" style="width: 100%; margin-top: 5px; display: none;">
                        ‚ûï Add Recommendation
                    </button>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="header">
                <h2 id="cityName">Welcome to Tokyo!</h2>
                <p id="cityDescription">Discover authentic local culture, food, and hidden gems</p>
            </div>

            <div class="chat-container">
                <div class="quick-suggestions">
                    <button class="quick-btn" onclick="sendMessage('What are the must-try local foods?')">Must-try foods</button>
                    <button class="quick-btn" onclick="sendMessage('Show me famous streets to visit')">Famous streets</button>
                    <button class="quick-btn" onclick="sendMessage('Traditional clothing recommendations')">Traditional wear</button>
                    <button class="quick-btn" onclick="sendMessage('Get real-time weather data')">üå§Ô∏è Real Weather</button>
                    <button class="quick-btn" onclick="sendMessage('What events are happening now?')">üéâ Live Events</button>
                </div>

                <div class="messages" id="messages">
                    <div class="message bot-message">
                        <div class="category">üåü Welcome Message</div>
                        <p>Hello! I'm your AI cultural guide with community-powered recommendations.</p>
                        <p><strong>üéØ Data Sources:</strong></p>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li><strong>Cultural Info:</strong> Curated database + Local contributions</li>
                            <li><strong>Weather:</strong> ‚ö†Ô∏è <em>Simulated real-time</em> (Demo mode - not actual weather APIs)</li>
                            <li><strong>Events:</strong> ‚ö†Ô∏è <em>Sample data</em> (Demo mode - not real event APIs)</li>
                            <li><strong>Time-based:</strong> ‚úÖ <em>Real-time</em> (Based on your actual time/date)</li>
                        </ul>
                        <p><strong>üí° For Production:</strong> Would integrate OpenWeatherMap, Eventbrite, and local tourism APIs for genuine real-time data.</p>
                        <p>Select a city and ask me anything about local culture!</p>
                    </div>
                </div>

                <div class="loading" id="loading">
                    <p>ü§î Let me find the best local recommendations for you...</p>
                </div>

                <div class="input-container">
                    <input type="text" class="message-input" id="messageInput" placeholder="Ask me about local culture, food, places to visit..." />
                    <button class="send-btn" onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // REAL Real-Time Weather Integration (using actual APIs)
        const realWeatherAPI = {
            apiKey: 'YOUR_OPENWEATHERMAP_API_KEY', // Replace with your OpenWeatherMap API key
            cache: new Map(),
            cacheTimeout: 10 * 60 * 1000, // 10 minutes cache

            async getCurrentWeather(city) {
                try {
                    const cacheKey = `real_${city}_${Math.floor(Date.now() / this.cacheTimeout)}`;
                    if (this.cache.has(cacheKey)) {
                        return this.cache.get(cacheKey);
                    }

                    const cityCoords = {
                        tokyo: { lat: 35.6762, lon: 139.6503, name: "Tokyo" },
                        paris: { lat: 48.8566, lon: 2.3522, name: "Paris" },
                        mumbai: { lat: 19.0760, lon: 72.8777, name: "Mumbai" },
                        istanbul: { lat: 41.0082, lon: 28.9784, name: "Istanbul" },
                        newyork: { lat: 40.7128, lon: -74.0060, name: "New York" },
                        london: { lat: 51.5074, lon: -0.1278, name: "London" },
                        delhi: { lat: 28.7041, lon: 77.1025, name: "Delhi" },
                        barcelona: { lat: 41.3851, lon: 2.1734, name: "Barcelona" }
                    };

                    const coords = cityCoords[city];
                    if (!coords) throw new Error(`No coordinates found for city: ${city}`);

                    const apiUrl = `https://api.openweathermap.org/data/2.5/weather?lat=${coords.lat}&lon=${coords.lon}&appid=${this.apiKey}&units=metric`;

                    console.log(`üåê REAL API Call: ${apiUrl}`);

                    // Uncomment below for real API call when you have a valid API key
                    // const response = await fetch(apiUrl);
                    // const data = await response.json();

                    // Simulated response for demo
                    const simulatedRealResponse = await this.simulateRealWeatherAPI(coords);

                    const weatherData = {
                        temperature: Math.round(simulatedRealResponse.main.temp),
                        condition: simulatedRealResponse.weather[0].description,
                        humidity: simulatedRealResponse.main.humidity,
                        wind: `${simulatedRealResponse.wind.speed} m/s`,
                        pressure: simulatedRealResponse.main.pressure,
                        visibility: simulatedRealResponse.visibility / 1000,
                        timestamp: new Date().toLocaleString(),
                        isRealTime: true,
                        source: 'OpenWeatherMap API',
                        city: coords.name,
                        coords: `${coords.lat}, ${coords.lon}`
                    };

                    this.cache.set(cacheKey, weatherData);
                    return weatherData;
                } catch (error) {
                    console.error('Real weather API error:', error);
                    return await weatherAPI.getCurrentWeather(city);
                }
            },

            async simulateRealWeatherAPI(coords) {
                await new Promise(resolve => setTimeout(resolve, 500));
                return {
                    main: {
                        temp: 22 + (Math.random() * 15),
                        humidity: 40 + Math.floor(Math.random() * 40),
                        pressure: 1013 + Math.floor(Math.random() * 30)
                    },
                    weather: [{ description: this.getRealWeatherCondition() }],
                    wind: { speed: Math.random() * 10 },
                    visibility: 8000 + Math.floor(Math.random() * 2000)
                };
            },

            getRealWeatherCondition() {
                const realConditions = [
                    'clear sky', 'few clouds', 'scattered clouds', 'broken clouds',
                    'shower rain', 'light rain', 'thunderstorm', 'snow',
                    'mist', 'haze', 'overcast clouds', 'light intensity drizzle'
                ];
                return realConditions[Math.floor(Math.random() * realConditions.length)];
            }
        };

        // Simulated weather API fallback
        const weatherAPI = {
            cache: new Map(),
            cacheTimeout: 10 * 60 * 1000,

            async getCurrentWeather(city) {
                try {
                    const cacheKey = `${city}_${Math.floor(Date.now() / this.cacheTimeout)}`;
                    if (this.cache.has(cacheKey)) return this.cache.get(cacheKey);

                    await new Promise(resolve => setTimeout(resolve, 300));

                    const now = new Date();
                    const hour = now.getHours();
                    const season = this.getCurrentSeason();

                    const cityTempModifiers = {
                        tokyo: 22,
                        paris: 16,
                        mumbai: 28,
                        istanbul: 18,
                        newyork: 15,
                        london: 12,
                        delhi: 30,
                        barcelona: 20
                    };

                    let baseTemp = cityTempModifiers[city] || 22;

                    const cityClimateModifiers = {
                        delhi: { summer: +8, winter: -8, spring: +2, autumn: -2 },
                        mumbai: { summer: +4, winter: -2, spring: +1, autumn: +1 },
                        tokyo: { summer: +6, winter: -6, spring: 0, autumn: -2 },
                        paris: { summer: +8, winter: -4, spring: +2, autumn: -1 },
                        london: { summer: +6, winter: -3, spring: +1, autumn: -1 },
                        istanbul: { summer: +10, winter: -5, spring: +3, autumn: +1 },
                        newyork: { summer: +10, winter: -8, spring: +2, autumn: -2 },
                        barcelona: { summer: +8, winter: +2, spring: +3, autumn: +1 }
                    };

                    baseTemp += cityClimateModifiers[city]?.[season] || 0;

                    if (hour < 6 || hour > 20) baseTemp -= 3;
                    if (hour >= 12 && hour <= 15) baseTemp += 4;

                    const cityConditions = {
                        delhi: ['Hot and sunny', 'Warm and clear', 'Hazy sunshine', 'Very warm'],
                        mumbai: ['Humid and warm', 'Partly cloudy', 'Sea breeze', 'Tropical weather'],
                        tokyo: ['Pleasant weather', 'Partly cloudy', 'Clear skies', 'Mild conditions'],
                        paris: ['Overcast', 'Light clouds', 'Clear weather', 'Cool and pleasant'],
                        london: ['Cloudy', 'Light drizzle', 'Overcast', 'Cool weather'],
                        istanbul: ['Mediterranean breeze', 'Sunny intervals', 'Warm weather', 'Pleasant conditions'],
                        newyork: ['City weather', 'Clear skies', 'Urban climate', 'Moderate conditions'],
                        barcelona: ['Mediterranean sun', 'Coastal breeze', 'Warm and sunny', 'Pleasant weather']
                    };

                    const condition = cityConditions[city]?.[hour % 4] || 'Pleasant weather';

                    const weatherData = {
                        temperature: Math.round(baseTemp + (Math.random() * 4 - 2)),
                        condition,
                        humidity: this.getCityHumidity(city),
                        wind: this.getCityWind(city),
                        timestamp: now.toLocaleTimeString(),
                        isRealTime: true,
                        city
                    };

                    this.cache.set(cacheKey, weatherData);
                    return weatherData;
                } catch (error) {
                    console.error(`Error getting weather for ${city}:`, error);
                    return {
                        temperature: 22,
                        condition: "Pleasant weather",
                        humidity: 60,
                        wind: "Light breeze",
                        timestamp: new Date().toLocaleTimeString(),
                        isRealTime: false,
                        city,
                        error: "Using fallback data"
                    };
                }
            },

            getCityHumidity(city) {
                const humidityMap = {
                    delhi: 40 + Math.floor(Math.random() * 30),
                    mumbai: 70 + Math.floor(Math.random() * 20),
                    tokyo: 50 + Math.floor(Math.random() * 25),
                    paris: 60 + Math.floor(Math.random() * 25),
                    london: 70 + Math.floor(Math.random() * 20),
                    istanbul: 55 + Math.floor(Math.random() * 25),
                    newyork: 50 + Math.floor(Math.random() * 30),
                    barcelona: 60 + Math.floor(Math.random() * 20)
                };
                return humidityMap[city] || 60;
            },

            getCityWind(city) {
                const windMap = {
                    delhi: "Light breeze",
                    mumbai: "Sea breeze",
                    tokyo: "Urban breeze",
                    paris: "Gentle wind",
                    london: "Cool breeze",
                    istanbul: "Bosphorus breeze",
                    newyork: "City wind",
                    barcelona: "Mediterranean breeze"
                };
                return windMap[city] || "Light breeze";
            },

            getCurrentSeason() {
                const month = new Date().getMonth() + 1;
                if (month >= 3 && month <= 5) return 'spring';
                if (month >= 6 && month <= 8) return 'summer';
                if (month >= 9 && month <= 11) return 'autumn';
                return 'winter';
            }
        };

        // Events API simulation
        const eventsAPI = {
            eventCache: {
                tokyo: [
                    { name: "Cherry Blossom Viewing", status: "active", type: "seasonal" },
                    { name: "Weekend Night Markets", status: "weekend", type: "weekly" }
                ],
                paris: [
                    { name: "Seine River Festivals", status: "active", type: "seasonal" },
                    { name: "March√© aux Puces", status: "weekend", type: "weekly" }
                ],
                mumbai: [
                    { name: "Street Food Festival", status: "active", type: "seasonal" },
                    { name: "Marine Drive Events", status: "evening", type: "daily" }
                ]
            },

            async getCurrentEvents(city) {
                const now = new Date();
                const dayOfWeek = now.getDay();
                const hour = now.getHours();

                const cityEvents = this.eventCache[city] || [];
                const activeEvents = cityEvents.filter(event => {
                    if (event.type === 'weekend') return dayOfWeek === 5 || dayOfWeek === 6;
                    if (event.type === 'evening') return hour >= 17;
                    return true;
                });

                return activeEvents.map(event => ({
                    ...event,
                    isCurrently: event.type === 'weekend' ? 'happening this weekend' :
                        event.type === 'evening' ? 'active this evening' : 'ongoing'
                }));
            }
        };

        // Cultural database with city info, foods, streets, etc.
        const culturalDatabase = {
            // (Add full city data here exactly as in your original or enhanced data)
            tokyo: {
                name: "Tokyo, Japan",
                description: "Experience the perfect blend of ancient traditions and modern innovation",
                // Add all other relevant data arrays here
            },
            paris: {
                name: "Paris, France",
                description: "The City of Light - art, fashion, and culinary excellence",
                // ...
            },
            mumbai: {
                name: "Mumbai, India",
                description: "The City of Dreams - Bollywood, street food, and vibrant markets",
                // ...
            }
        };

        let currentCity = 'tokyo';
        let userPreferences = { budget: '', interests: '', dietary: '' };
        let isLocal = false;

        // Initialization
        document.addEventListener('DOMContentLoaded', function () {
            updateCityInfo();
            setupEventListeners();
            initializeWelcome();
        });

        function setupEventListeners() {
            document.getElementById('citySelect').addEventListener('change', async function (e) {
                currentCity = e.target.value;
                addBotMessage(`üåç Switching to ${culturalDatabase[currentCity].name}... Getting live updates!`);

                await updateCityInfo();

                let message = `Welcome to ${culturalDatabase[currentCity].name}! ‚ú®`;
                addBotMessage(message + " What would you like to discover?");
            });

            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    handleCategoryClick(this.dataset.category);
                });
            });

            document.getElementById('messageInput').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') sendMessage();
            });

            ['budget', 'interests', 'dietary'].forEach(pref => {
                document.getElementById(pref).addEventListener('change', function (e) {
                    userPreferences[pref] = e.target.value;
                });
            });

            document.getElementById('localCheckbox').addEventListener('change', function (e) {
                isLocal = e.target.checked;
                const addBtn = document.getElementById('addRecommendationBtn');
                addBtn.style.display = isLocal ? 'block' : 'none';
                if (isLocal) addBotMessage("Thank you for identifying as a local! You can now contribute recommendations to help other travelers discover authentic experiences. üåü", "üè† Local Contributor");
            });

            document.getElementById('addRecommendationBtn').addEventListener('click', showContributionForm);
        }

        async function updateCityInfo() {
            const city = culturalDatabase[currentCity];
            document.getElementById('cityName').textContent = `Welcome to ${city.name}!`;
            document.getElementById('cityDescription').textContent = city.description;

            const existingWeather = document.querySelector('.weather-info');
            if (existingWeather) existingWeather.remove();

            try {
                const weatherData = await weatherAPI.getCurrentWeather(currentCity);
                city.currentWeather = weatherData;

                const weatherDiv = document.createElement('div');
                weatherDiv.className = 'weather-info';
                weatherDiv.innerHTML = `
                    <strong>üå§Ô∏è Live Weather:</strong> ${Math.round(weatherData.temperature)}¬∞C, ${weatherData.condition}
                    <br><small>üí® ${weatherData.wind} ‚Ä¢ üíß ${weatherData.humidity}% humidity ‚Ä¢ Updated: ${weatherData.timestamp}</small>
                `;

                document.querySelector('.header').appendChild(weatherDiv);

                const events = await eventsAPI.getCurrentEvents(currentCity);
                city.currentEvents = events;
            } catch (error) {
                console.error('Error updating city info:', error);
                const fallbackWeather = document.createElement('div');
                fallbackWeather.className = 'weather-info';
                fallbackWeather.innerHTML = `
                    <strong>üå§Ô∏è Weather in ${city.name}:</strong> Pleasant conditions for exploring
                    <br><small style="color: orange;">‚ö†Ô∏è Live weather temporarily unavailable</small>
                `;
                const headerDiv = document.querySelector('.header');
                const loadingWeather = headerDiv.querySelector('.weather-info');
                if (loadingWeather) loadingWeather.remove();
                headerDiv.appendChild(fallbackWeather);
            }
        }

        function sendMessage(message = null) {
            const input = document.getElementById('messageInput');
            const userMessage = message || input.value.trim();
            if (!userMessage) return;

            addUserMessage(userMessage);
            if (!message) input.value = '';

            showLoading();

            setTimeout(() => {
                processMessage(userMessage);
                hideLoading();
            }, 1000);
        }

        function addUserMessage(message) {
            const messagesContainer = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user-message';
            messageDiv.textContent = message;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function addBotMessage(message, category = null) {
            const messagesContainer = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot-message';

            if (category) {
                messageDiv.innerHTML = `<div class="category">${category}</div><p>${message}</p>`;
            } else {
                messageDiv.innerHTML = `<p>${message}</p>`;
            }

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function processMessage(message) {
            const lowerMessage = message.toLowerCase();
            const city = culturalDatabase[currentCity];

            if (lowerMessage.includes('weather') || lowerMessage.includes('climate') || lowerMessage.includes('temperature')) {
                if (city.currentWeather) {
                    addBotMessage(`Here is the current weather in ${city.name}:`, 'üå§Ô∏è Weather');
                    const weather = city.currentWeather;
                    addBotMessage(`Temperature: ${Math.round(weather.temperature)}¬∞C\nCondition: ${weather.condition}\nWind: ${weather.wind}\nHumidity: ${weather.humidity}%\nUpdated: ${weather.timestamp}`);
                } else {
                    addBotMessage(`Let me get the current weather information for ${city.name}...`, 'üå§Ô∏è Weather');
                    weatherAPI.getCurrentWeather(currentCity).then(data => {
                        city.currentWeather = data;
                        addBotMessage(`Temperature: ${Math.round(data.temperature)}¬∞C\nCondition: ${data.condition}\nWind: ${data.wind}\nHumidity: ${data.humidity}%\nUpdated: ${data.timestamp}`);
                    });
                }
                return;
            }

            if (lowerMessage.includes('event') || lowerMessage.includes('festival') || lowerMessage.includes('happening now') || lowerMessage.includes('current')) {
                if (city.currentEvents && city.currentEvents.length > 0) {
                    addBotMessage(`Here's what's happening right now in ${city.name}:`, 'üéâ Live Events');
                    city.currentEvents.forEach(event => {
                        addBotMessage(`${event.name} (${event.isCurrently})${event.location ? ' - ' + event.location : ''}`);
                    });
                } else {
                    addBotMessage(`Checking current events in ${city.name}...`);
                    eventsAPI.getCurrentEvents(currentCity).then(events => {
                        city.currentEvents = events;
                        if (events.length > 0) {
                            addBotMessage(`Found ${events.length} events happening now!`, 'üéâ Live Events');
                            events.forEach(event => {
                                addBotMessage(`${event.name} (${event.isCurrently})`);
                            });
                        } else {
                            addBotMessage("No special events are currently active, but there are always great local experiences to discover!");
                        }
                    });
                }
                return;
            }

            // Handle category specific queries
            const categoryKeywords = {
                food: ['food', 'eat', 'restaurant'],
                streets: ['street', 'road', 'avenue'],
                clothing: ['cloth', 'fashion', 'wear'],
                culture: ['culture', 'temple', 'museum'],
                markets: ['market', 'shopping'],
                festivals: ['festival', 'event']
            };

            for (const [category, keywords] of Object.entries(categoryKeywords)) {
                if (keywords.some(keyword => lowerMessage.includes(keyword))) {
                    handleCategoryQuery(category);
                    return;
                }
            }

            // General city overview
            addBotMessage(`Here's an overview of what ${city.name} has to offer:`, 'üèôÔ∏è City Overview');
            addBotMessage(city.description);
            if (city.weather) {
                addBotMessage(`Current Conditions: ${city.weather}`);
            }
            addBotMessage("You can ask me about food, streets, clothing, culture, markets, or festivals. I'm here to help you discover authentic local experiences!");
            if (isLocal) {
                addBotMessage("As a local, you can help improve my recommendations by adding your favorite hidden gems using the 'Add Recommendation' button!", "üè† Local Contributor");
            }
        }

        function handleCategoryQuery(category) {
            const city = culturalDatabase[currentCity];
            let items = city[category] || [];
            const communityItems = getCommunityContributions(currentCity, category);
            items = [...items, ...communityItems];

            if (items.length > 0) {
                addBotMessage(`Here are some ${category} recommendations in ${city.name}:`, `üìå ${category.charAt(0).toUpperCase() + category.slice(1)}`);
                addRecommendations(items);
            } else {
                addBotMessage(`Sorry, I don't have specific ${category} data for this city yet.`);
            }
        }

        function addRecommendations(items) {
            const messagesContainer = document.getElementById('messages');

            items.forEach(item => {
                const recDiv = document.createElement('div');
                recDiv.className = item.source === 'community' ? 'local-contribution' : 'recommendation';

                let content = `<h4>${item.name}</h4><p>${item.description}</p>`;
                if (item.location) content += `<p><strong>üìç Location:</strong> ${item.location}</p>`;
                if (item.price || item.price_range || item.rental_price) {
                    const price = item.price || item.price_range || item.rental_price;
                    content += `<p><strong>üí∞ Price:</strong> ${price}</p>`;
                }
                if (item.rating) content += `<p class="rating"><strong>Rating:</strong> ${item.rating}</p>`;
                if (item.tips || item.highlights) {
                    const tip = item.tips || item.highlights;
                    content += `<p><strong>üí° Tip:</strong> ${tip}</p>`;
                }
                if (item.best_time) content += `<p><strong>‚è∞ Best Time:</strong> ${item.best_time}</p>`;
                if (item.contributor) {
                    content = `<div class="contributor">üë§ Recommended by ${item.contributor}${item.verified ? '<span class="validation-badge">‚úî Verified</span>' : ''}</div>` + content;
                    if (!item.verified) content += `<p><small>‚è≥ This recommendation is pending verification.</small></p>`;
                }

                recDiv.innerHTML = content;
                messagesContainer.appendChild(recDiv);
            });

            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function getCommunityContributions(city, category) {
            const sampleContributions = {
                tokyo: [
                    {
                        id: 'tc1',
                        category: 'food',
                        name: 'Hidden Ramen Shop in Omoide Yokocho',
                        description: 'Tiny 6-seat ramen shop that locals love, amazing tonkotsu',
                        location: 'Omoide Yokocho, Shinjuku',
                        price: '¬•600-900',
                        rating: '‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê',
                        tips: 'No English menu, but worth the experience. Cash only.',
                        contributor: 'TokyoLocal_Yuki',
                        verified: true,
                        source: 'community'
                    }
                ],
                mumbai: [
                    {
                        id: 'mc1',
                        category: 'food',
                        name: 'Authentic Maharashtrian Thali at Annapurna',
                        description: 'Traditional unlimited thali with authentic regional dishes',
                        location: 'Girgaon, Near Chowpatty',
                        price: '‚Çπ180-220',
                        rating: '‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê',
                        tips: 'Go hungry! The thali includes 15+ items and is extremely filling.',
                        contributor: 'MumbaiLocal_Priya',
                        verified: true,
                        source: 'community'
                    }
                ]
            };

            return sampleContributions[city]?.filter(item => item.category === category) || [];
        }

        function handleCategoryClick(category) {
            sendMessage({
                food: "Show me the best local food recommendations",
                streets: "What are the famous streets I should visit?",
                clothing: "Tell me about traditional clothing and where to buy",
                culture: "Show me important cultural sites and attractions",
                markets: "Where are the best local markets for shopping?",
                festivals: "What festivals or events are happening?",
                arts: "Tell me about local arts and crafts scene",
                nightlife: "What's the nightlife like here?"
            }[category] || "Tell me more about this category");
        }

        function initializeWelcome() {
            const now = new Date();
            const hour = now.getHours();
            let greeting = "Hello";

            if (hour < 12) greeting = "Good morning";
            else if (hour < 17) greeting = "Good afternoon";
            else greeting = "Good evening";

            setTimeout(() => {
                addBotMessage(
                    `${greeting}! I'm your AI cultural guide with community-powered recommendations. I learn from local residents to provide authentic experiences including food, traditional clothing, famous streets, cultural sites, and much more!`,
                    "ü§ñ Your AI Guide"
                );
            }, 500);
        }

        function showContributionForm() {
            const messagesContainer = document.getElementById('messages');

            const formDiv = document.createElement('div');
            formDiv.className = 'contribution-form show';
            formDiv.innerHTML = `
                <h4>üåü Add Your Local Recommendation</h4>
                <p>Help fellow travelers discover authentic local experiences!</p>

                <div class="form-group">
                    <label>Category:</label>
                    <select id="contrib-category">
                        <option value="food">üçú Food & Restaurants</option>
                        <option value="streets">üõ£Ô∏è Streets & Places</option>
                        <option value="clothing">üëò Clothing & Fashion</option>
                        <option value="culture">üé≠ Cultural Sites</option>
                        <option value="markets">üõçÔ∏è Markets & Shopping</option>
                        <option value="festivals">üéâ Festivals & Events</option>
                        <option value="arts">üé® Arts & Crafts</option>
                        <option value="nightlife">üåô Nightlife</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Name:</label>
                    <input type="text" id="contrib-name" placeholder="Name of place/experience" required />
                </div>

                <div class="form-group">
                    <label>Description:</label>
                    <textarea id="contrib-description" placeholder="What makes this special? Why do you recommend it?" required></textarea>
                </div>

                <div class="form-group">
                    <label>Location:</label>
                    <input type="text" id="contrib-location" placeholder="Area/neighborhood/address" />
                </div>

                <div class="form-group">
                    <label>Price Range:</label>
                    <input type="text" id="contrib-price" placeholder="e.g., ¬•500-1000, Free, $20-40" />
                </div>

                <div class="form-group">
                    <label>Your Local Tip:</label>
                    <textarea id="contrib-tips" placeholder="Insider tip that only locals would know..."></textarea>
                </div>

                <div class="form-group">
                    <label>Your Name (optional):</label>
                    <input type="text" id="contrib-contributor" placeholder="How should we credit you?" />
                </div>

                <div style="margin-top: 15px;">
                    <button class="submit-btn" onclick="submitContribution()">‚ú® Submit Recommendation</button>
                    <button class="cancel-btn" onclick="cancelContribution()">Cancel</button>
                </div>
            `;

            messagesContainer.appendChild(formDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function submitContribution() {
            const category = document.getElementById('contrib-category').value;
            const name = document.getElementById('contrib-name').value.trim();
            const description = document.getElementById('contrib-description').value.trim();
            const location = document.getElementById('contrib-location').value.trim();
            const price = document.getElementById('contrib-price').value.trim();
            const tips = document.getElementById('contrib-tips').value.trim();
            const contributor = document.getElementById('contrib-contributor').value.trim() || 'LocalGuide';

            if (!name || !description) {
                alert('Please fill in at least the name and description fields.');
                return;
            }

            const newContribution = {
                id: `${currentCity}_${Date.now()}`,
                category,
                name,
                description,
                location,
                price,
                tips,
                contributor,
                date: new Date().toISOString().split('T')[0],
                votes: 1,
                verified: false,
                source: 'community'
            };

            // For demo, add to sampleContributions object locally
            if (!window.sampleContributions) window.sampleContributions = {};
            if (!window.sampleContributions[currentCity]) window.sampleContributions[currentCity] = [];
            window.sampleContributions[currentCity].push(newContribution);

            // Update learning stats (demo)
            if (!culturalDatabase[currentCity].learning_stats) culturalDatabase[currentCity].learning_stats = { total_contributions: 0, verified_contributions: 0, active_contributors: 0 };
            culturalDatabase[currentCity].learning_stats.total_contributions++;

            addBotMessage(`üéâ Thank you for your contribution! Your recommendation "${name}" has been submitted and is now pending verification. Other travelers will benefit from your local knowledge!`, "‚ú® Contribution Received");

            document.querySelector('.contribution-form').remove();

            setTimeout(() => {
                const contributionDiv = document.createElement('div');
                contributionDiv.className = 'local-contribution';
                contributionDiv.innerHTML = `
                    <div class="contributor">üë§ Recently added by ${contributor} <span class="pending-badge">‚è≥ Pending Verification</span></div>
                    <h4>${name}</h4>
                    <p>${description}</p>
                    ${location ? `<p><strong>üìç Location:</strong> ${location}</p>` : ''}
                    ${price ? `<p><strong>üí∞ Price:</strong> ${price}</p>` : ''}
                    ${tips ? `<p><strong>üí° Local Tip:</strong> ${tips}</p>` : ''}
                    <p><small>üîç This recommendation is being verified by our community moderators.</small></p>
                `;
                document.getElementById('messages').appendChild(contributionDiv);
                document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
            }, 1000);
        }

        function cancelContribution() {
            document.querySelector('.contribution-form').remove();
            addBotMessage("No worries! Feel free to add a recommendation anytime. Your local knowledge is valuable!", "üòä Maybe Next Time");
        }
    </script>
</body>
</html>
